<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>hub - Family Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .hub-title { 
            font-family: 'Pacifico', cursive;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .page { 
            animation: fadeIn 0.4s ease-in-out; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .nav-icon {
            transition: all 0.3s ease;
            position: relative;
        }
        .nav-icon:hover {
            transform: translateY(-2px);
        }
        .nav-icon.active .ph { 
            color: #3b82f6; 
        }
        .nav-icon.active::after { 
            content: ''; 
            position: absolute; 
            bottom: -8px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 24px; 
            height: 4px; 
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 2px; 
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .list-item { 
            transition: all 0.3s ease; 
            cursor: pointer;
            border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.8);
        }
        .list-item:hover { 
            background: rgba(255, 255, 255, 1);
            transform: translateX(4px);
            border-color: rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .shopping-item-done { 
            text-decoration: line-through; 
            color: #9ca3af; 
        }
        
        .list-item .icon-container {
            flex-shrink: 0;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            height: 40px;
            width: 40px;
            justify-content: center;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 8px;
        }

        /* Remove all list styling */
        ul, ol, li, div {
            list-style: none !important;
            list-style-type: none !important;
        }
        .list-item::before, .list-item::after, 
        .list-item *::before, .list-item *::after {
            content: none !important;
        }

        .nav-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        }

        .add-btn {
            background: linear-gradient(135deg, #f97316, #ea580c);
            box-shadow: 0 8px 32px rgba(249, 115, 22, 0.4);
            transition: all 0.3s ease;
        }
        .add-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 40px rgba(249, 115, 22, 0.6);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .person-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .category-icon {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 8px;
            padding: 0.5rem;
        }

        /* Calendar customization */
        .fc-theme-standard .fc-scrollgrid {
            border-radius: 12px;
            overflow: hidden;
        }
        
        .fc-event {
            border-radius: 6px !important;
            border: none !important;
            font-weight: 500;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }

        /* Form styling */
        input, select, textarea {
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
        }

        .empty-state {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="max-w-4xl mx-auto p-4 md:p-6 pb-24">
        <header class="py-6 mb-4 text-center">
            <h1 class="hub-title text-5xl md:text-6xl text-white">hub</h1>
            <p class="text-white/80 text-sm mt-2">Your family's central command center</p>
        </header>

        <nav class="nav-container rounded-2xl p-3 my-6 sticky top-4 z-10">
            <div class="flex justify-around items-center">
                 <button class="nav-icon relative p-3 rounded-xl" data-page="hub">
                     <i class="ph-bold ph-house text-gray-500 text-2xl"></i>
                 </button>
                 <button class="nav-icon relative p-3 rounded-xl" data-page="calendar">
                     <i class="ph-bold ph-calendar-blank text-gray-500 text-2xl"></i>
                 </button>
                 <button class="nav-icon relative p-3 rounded-xl" data-page="shopping">
                     <i class="ph-bold ph-shopping-cart-simple text-gray-500 text-2xl"></i>
                 </button>
                 <button class="nav-icon relative p-3 rounded-xl" data-page="health">
                     <i class="ph-bold ph-heartbeat text-gray-500 text-2xl"></i>
                 </button>
                 <button class="nav-icon relative p-3 rounded-xl" data-page="meals">
                     <i class="ph-bold ph-fork-knife text-gray-500 text-2xl"></i>
                 </button>
                 <button class="nav-icon relative p-3 rounded-xl" data-page="contacts">
                     <i class="ph-bold ph-users text-gray-500 text-2xl"></i>
                 </button>
            </div>
        </nav>

        <main id="main-content">
            <div id="hub-page" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6 rounded-2xl col-span-1 md:col-span-2">
                        <h2 class="text-2xl font-bold mb-2 text-gray-800">Today's Schedule</h2>
                        <p id="current-date" class="text-sm text-gray-500 mb-6"></p>
                        <div id="schedule-list" class="space-y-3"></div>
                    </div>
                    <div class="card p-6 rounded-2xl">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Today's Meals</h2>
                        <div id="meals-list" class="space-y-3"></div>
                    </div>
                    <div class="card p-6 rounded-2xl">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Shopping List</h2>
                        <div id="shopping-list-hub" class="space-y-3"></div>
                    </div>
                    <div class="card p-6 rounded-2xl col-span-1 md:col-span-2">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Upcoming Events</h2>
                        <div id="upcoming-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
            
            <div id="shopping-page" class="page hidden"></div>
            <div id="calendar-page" class="page hidden"></div>
            <div id="health-page" class="page hidden"></div>
            <div id="meals-page" class="page hidden"></div>
            <div id="contacts-page" class="page hidden"></div>
        </main>
    </div>

    <button id="add-item-btn" class="add-btn fixed bottom-8 right-8 text-white w-16 h-16 rounded-full flex items-center justify-center z-20">
        <i class="ph-bold ph-plus text-3xl"></i>
    </button>
    
    <div id="edit-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="card rounded-2xl p-8 shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col">
            <h3 id="modal-title" class="text-2xl font-bold mb-6 flex-shrink-0 text-gray-800">Edit Item</h3>
            <form id="edit-form" class="space-y-5 flex-grow overflow-y-auto pr-2">
                <div id="modal-form-content"></div>
            </form>
            <div class="flex justify-between items-center pt-6 mt-6 border-t border-gray-200 flex-shrink-0">
                <button type="button" id="delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover:transform hover:scale-105">Delete</button>
                <div class="space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-xl transition-all duration-300">Cancel</button>
                    <button type="submit" form="edit-form" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover:transform hover:scale-105">Save</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
// Simplified in-memory data storage for demo
let data = {
    schedule: [
        { id: '1', title: 'Drop off Leo at School', person: 'Dad', startDate: new Date().toISOString().split('T')[0], startTime: '08:00', endTime: '08:30', category: 'School', allDay: false },
        { id: '2', title: 'Doctor Appointment', person: 'Mom', startDate: new Date().toISOString().split('T')[0], startTime: '10:30', endTime: '11:30', category: 'Doctor', allDay: false },
        { id: '3', title: 'Soccer Practice', person: 'Leo', startDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], startTime: '16:00', endTime: '17:30', category: 'Sport', allDay: false }
    ],
    meals: [
        { id: '1', title: 'Pancakes & Berries', label: 'Breakfast', date: new Date().toISOString().split('T')[0] },
        { id: '2', title: 'Chicken Caesar Salad', label: 'Lunch', date: new Date().toISOString().split('T')[0] },
        { id: '3', title: 'Grilled Salmon & Vegetables', label: 'Dinner', date: new Date().toISOString().split('T')[0] }
    ],
    stores: [
        { id: '1', name: 'Grocery Store' },
        { id: '2', name: 'Hardware Store' },
        { id: '3', name: 'Target' }
    ],
    storeItems: [
        { id: '1', name: 'Milk', category: 'Dairy & Eggs', storeId: '1' },
        { id: '2', name: 'Bananas', category: 'Produce', storeId: '1' },
        { id: '3', name: 'Chicken Breast', category: 'Meat & Seafood', storeId: '1' },
        { id: '4', name: 'Screws', category: 'Hardware', storeId: '2' }
    ],
    shoppingList: [
        { id: '1', name: 'Milk', category: 'Dairy & Eggs', done: false, price: 3.99, storeItemId: '1', storeId: '1' },
        { id: '2', name: 'Bananas', category: 'Produce', done: true, price: 2.50, storeItemId: '2', storeId: '1' }
    ],
    health: [
        { id: '1', person: 'Leo', name: 'Daily Vitamin', dosage: '1 gummy', time: '08:00' },
        { id: '2', person: 'Mom', name: 'Blood Pressure Med', dosage: '10mg', time: '09:00' }
    ],
    contacts: [
        { id: '1', name: 'Mom', birthday: '1985-10-20' },
        { id: '2', name: 'Dad', birthday: '1984-05-15' },
        { id: '3', name: 'Leo', birthday: '2015-07-22' }
    ]
};

let currentPageId = 'hub';
let currentStoreId = null;

// Helper functions
const toISODate = (date) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split("T")[0];
const groupBy = (arr, key) => arr.reduce((acc, item) => { (acc[item[key]] = acc[item[key]] || []).push(item); return acc; }, {});
const generateId = () => Date.now().toString();

// UI Module
const ui = {
    modal: document.getElementById('edit-modal'),
    modalTitle: document.getElementById('modal-title'),
    formContent: document.getElementById('modal-form-content'),
    editForm: document.getElementById('edit-form'),
    deleteBtn: document.getElementById('delete-btn'),
    cancelBtn: document.getElementById('cancel-btn'),
    
    init() {
        this.editForm.onsubmit = (e) => app.handleFormSubmit(e);
        this.deleteBtn.onclick = () => app.handleDelete();
        this.cancelBtn.onclick = () => this.closeModal();
        this.modal.onclick = (e) => { if (e.target === this.modal) this.closeModal(); };
        
        document.querySelectorAll('.nav-icon').forEach(btn => btn.onclick = () => app.navigate(btn.dataset.page));
        document.getElementById('add-item-btn').onclick = () => app.handleAddItem();
        document.getElementById('main-content').addEventListener('click', (e) => app.handleMainContentClick(e));
    },

    openModal(type, id = null, extraParams = {}) {
        const isNew = id === null;
        this.modal.dataset.type = type;
        this.modal.dataset.id = id;
        this.deleteBtn.classList.toggle('hidden', isNew);
        this.modalTitle.textContent = `${isNew ? 'Add New' : 'Edit'} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        this.formContent.innerHTML = this.getFormFields(type, id, extraParams);
        this.modal.classList.remove('hidden');

        const allDayCheckbox = document.getElementById('edit-all-day');
        if (allDayCheckbox) {
            const timeFields = document.getElementById('time-fields');
            const toggleTimeFields = () => { timeFields.classList.toggle('hidden', allDayCheckbox.checked); };
            allDayCheckbox.onchange = toggleTimeFields;
            toggleTimeFields();
        }
    },

    closeModal() { 
        this.modal.classList.add('hidden'); 
    },

    getFormFields(type, id, extraParams = {}) {
        let item = {};
        if (id && data[type]) item = data[type].find(d => d.id === id) || {};

        const createField = (label, id, type, value = '', props = '') => `
            <div>
                <label for="${id}" class="block text-sm font-semibold text-gray-700 mb-2">${label}</label>
                <input type="${type}" id="${id}" value="${value}" ${props} class="block w-full border-gray-300 rounded-xl shadow-sm p-3 border focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>`;
        
        const createSelect = (label, id, options, selected = '') => `
            <div>
                <label for="${id}" class="block text-sm font-semibold text-gray-700 mb-2">${label}</label>
                <select id="${id}" class="block w-full border-gray-300 rounded-xl shadow-sm p-3 border focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    ${options.map(o => `<option value="${o}" ${o === selected ? 'selected' : ''}>${o}</option>`).join('')}
                </select>
            </div>`;
        
        const createCheckbox = (label, id, checked) => `
            <div class="flex items-center space-x-3">
                <input type="checkbox" id="${id}" ${checked ? 'checked' : ''} class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="${id}" class="block text-sm font-semibold text-gray-900">${label}</label>
            </div>`;
        
        const personOptions = (data.contacts || []).map(c => c.name);
        const SHOPPING_CATEGORIES = ["Produce", "Dairy & Eggs", "Meat & Seafood", "Pantry", "Bakery", "Frozen", "Beverages", "Household", "Personal Care", "Pets", "Other"];
        
        switch(type) {
            case 'schedule':
                const categoryIcons = { 'General': 'calendar-plus', 'School': 'graduation-cap', 'Health': 'first-aid-kit', 'Doctor': 'stethoscope', 'Dentist': 'tooth', 'Work': 'briefcase', 'Sport': 'trophy', 'Social': 'users', 'Chore': 'trash' };
                return createField('Event Title', 'edit-title', 'text', item.title || '', 'required') +
                       createSelect('Category', 'edit-category', Object.keys(categoryIcons), item.category || 'General') +
                       createSelect('Assigned To', 'edit-person', personOptions, item.person) +
                       createField('Date', 'edit-start-date', 'date', item.startDate || extraParams.startDate || toISODate(new Date()), 'required') +
                       createCheckbox('All-day event', 'edit-all-day', item.allDay === true) +
                       `<div id="time-fields" class="grid grid-cols-2 gap-4">` +
                       createField('Start Time', 'edit-start-time', 'time', item.startTime || '') +
                       createField('End Time', 'edit-end-time', 'time', item.endTime || '') + '</div>';
            case 'stores':
                return createField('Store Name', 'edit-store-name', 'text', item.name || '', 'required');
            case 'storeItems':
                 return createField('Item Name', 'edit-item-name', 'text', item.name || '', 'required') +
                        createSelect('Category', 'edit-item-category', SHOPPING_CATEGORIES, item.category || 'Other');
            case 'health':
                return createSelect('Person', 'edit-health-person', personOptions, item.person) + 
                       createField('Medication/Item', 'edit-health-name', 'text', item.name || '', 'required') + 
                       createField('Dosage', 'edit-health-dosage', 'text', item.dosage || '') + 
                       createField('Time', 'edit-health-time', 'time', item.time || '');
            case 'meals':
                return createField('Date', 'edit-meal-date', 'date', item.date || toISODate(new Date()), 'required') + 
                       createSelect('Meal Type', 'edit-meal-label', ['Breakfast', 'Lunch', 'Dinner', 'Snack'], item.label) + 
                       createField('Meal Title', 'edit-meal-title', 'text', item.title || '', 'required');
            case 'contacts':
                return createField('Name', 'edit-contact-name', 'text', item.name || '', 'required') +
                       createField('Birthday', 'edit-contact-birthday', 'date', item.birthday || '');
        }
        return '';
    },

    refreshUI() {
        const renderMap = {
            'hub': this.renderHubPage, 'calendar': this.renderCalendarPage, 'shopping': this.renderShoppingPage,
            'health': this.renderHealthPage, 'meals': this.renderMealsPage, 'contacts': this.renderContactsPage
        };
        renderMap[currentPageId]?.call(this);
    },
    
    renderHubPage() {
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        const schedule = data.schedule || [];
        const todayEvents = schedule.filter(item => item.startDate === toISODate(new Date())).sort((a,b) => (a.startTime || '').localeCompare(b.startTime || ''));
        document.getElementById('schedule-list').innerHTML = todayEvents.length ? 
            todayEvents.map(item => this.createScheduleListItem(item)).join('') : 
            `<div class="empty-state p-6 text-center">
                <i class="ph-bold ph-calendar-x text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-500">No events scheduled for today</p>
            </div>`;

        const upcomingEvents = schedule.filter(item => item.startDate > toISODate(new Date())).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
        const upcomingBirthdays = this.getUpcomingBirthdays();
        const allUpcoming = [...upcomingEvents, ...upcomingBirthdays].sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
        document.getElementById('upcoming-list').innerHTML = allUpcoming.length ? 
            allUpcoming.slice(0, 5).map(item => this.createScheduleListItem(item, true)).join('') : 
            `<div class="empty-state p-6 text-center">
                <i class="ph-bold ph-calendar-x text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-500">No upcoming events</p>
            </div>`;

        const todaysMeals = (data.meals || []).filter(meal => meal.date === toISODate(new Date()));
        document.getElementById('meals-list').innerHTML = todaysMeals.length ? 
            todaysMeals.map(item => this.createMealListItem(item)).join('') : 
            `<div class="empty-state p-6 text-center">
                <i class="ph-bold ph-fork-knife text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-500">No meals planned for today</p>
            </div>`;
        
        const shoppingList = data.shoppingList || [];
        const neededCount = shoppingList.filter(i => !i.done).length;
        document.getElementById('shopping-list-hub').innerHTML = `
            <div class="list-item p-4 rounded-xl" data-page-nav="shopping">
                <div class="flex items-center w-full">
                    <div class="icon-container">
                        <i class="ph-bold ph-shopping-cart-simple text-xl text-orange-500"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold">Shopping List</p>
                        <p class="text-sm text-gray-500">${neededCount} items needed</p>
                    </div>
                    <i class="ph-bold ph-caret-right text-xl text-gray-400"></i>
                </div>
            </div>`;
    },

    createScheduleListItem(item, isUpcoming = false) {
        const categoryIcons = { 
            'General': 'calendar-plus', 'School': 'graduation-cap', 'Health': 'first-aid-kit', 
            'Doctor': 'stethoscope', 'Dentist': 'tooth', 'Work': 'briefcase', 
            'Sport': 'trophy', 'Social': 'users', 'Chore': 'trash', 'Birthday': 'cake' 
        };
        const formatTime = (t) => t ? new Date(`1970-01-01T${t}`).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : 'All Day';
        const getPersonBadgeClass = (p) => {
            const classes = {
                'Dad': 'bg-blue-100 text-blue-800',
                'Mom': 'bg-pink-100 text-pink-800',
                'Leo': 'bg-green-100 text-green-800'
            };
            return classes[p] || 'bg-gray-100 text-gray-800';
        };
        
        return `
            <div class="list-item p-4 rounded-xl" data-id="${item.id}" data-type="${item.category === 'Birthday' ? 'contacts' : 'schedule'}">
                <div class="flex items-center w-full">
                    <div class="icon-container">
                        <i class="ph-bold ph-${categoryIcons[item.category] || 'question'} text-xl text-indigo-500"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${item.title}</p>
                        <p class="text-sm text-gray-500">
                            ${isUpcoming ? 
                                new Date(item.startDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : 
                                formatTime(item.startTime)
                            }
                        </p>
                    </div>
                    <span class="person-badge ${getPersonBadgeClass(item.person)} ml-3">${item.person}</span>
                </div>
            </div>`;
    },

    createMealListItem(item) {
        const mealIcons = { 
            'Breakfast': 'coffee', 'Lunch': 'hamburger', 'Dinner': 'pot', 'Snack': 'cookie' 
        };
        return `
            <div class="list-item p-4 rounded-xl" data-id="${item.id}" data-type="meals">
                <div class="flex items-center w-full">
                    <div class="icon-container">
                        <i class="ph-bold ph-${mealIcons[item.label] || 'utensils'} text-xl text-orange-500"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${item.title}</p>
                        <p class="text-sm text-gray-500">${item.label}</p>
                    </div>
                </div>
            </div>`;
    },

    renderShoppingPage() {
        if(currentStoreId){
            this.renderStoreDetailPage(currentStoreId);
            return;
        }

        const pageEl = document.getElementById('shopping-page');
        const shoppingList = data.shoppingList || [];
        const listHtml = shoppingList.length > 0 ? this.renderActiveShoppingList(true) : 
            `<div class="empty-state p-8 text-center">
                <i class="ph-bold ph-shopping-cart text-5xl text-gray-400 mb-4"></i>
                <p class="text-gray-500 text-lg">Your shopping list is empty</p>
                <p class="text-gray-400 text-sm mt-2">Add items from a store below</p>
            </div>`;
        
        pageEl.innerHTML = `
            <div class="card p-6 rounded-2xl mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Active Shopping List</h2>
                    <button id="clear-list-btn" class="text-sm bg-red-100 hover:bg-red-200 text-red-700 font-semibold px-4 py-2 rounded-xl transition-colors">Complete & Clear</button>
                </div>
                <div id="active-list-container">${listHtml}</div>
            </div>
            <div class="card p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Stores</h2>
                <div id="stores-container" class="space-y-3"></div>
            </div>`;
        
        const storesContainer = document.getElementById('stores-container');
        const stores = data.stores || [];
        storesContainer.innerHTML = stores.length ? stores.map(store => `
            <div class="list-item p-4 rounded-xl border" data-store-id="${store.id}">
                <div class="flex items-center w-full">
                    <div class="icon-container">
                        <i class="ph-bold ph-storefront text-xl text-indigo-500"></i>
                    </div>
                    <span class="font-semibold flex-grow text-gray-800">${store.name}</span>
                    <i class="ph-bold ph-caret-right text-xl text-gray-400"></i>
                </div>
            </div>`).join('') : 
            `<div class="empty-state p-6 text-center">
                <i class="ph-bold ph-storefront text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-500">No stores configured yet</p>
            </div>`;
        
        const clearBtn = document.getElementById('clear-list-btn');
        if(clearBtn) clearBtn.onclick = () => app.clearShoppingList();
    },
    
    renderActiveShoppingList(fromShoppingPage = false) {
        const list = data.shoppingList || [];
        if (!list.length && fromShoppingPage) return '';
        const grouped = groupBy(list, 'category');
        const categories = Object.keys(grouped).sort();

        let listHtml = categories.map(category => `
            <div class="mb-4">
                <h3 class="font-bold text-gray-600 text-sm uppercase tracking-wider mb-3">${category}</h3>
                <div class="space-y-2">
                    ${grouped[category].map(item => `
                        <div class="flex items-center p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors" data-item-id="${item.id}">
                            <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 mr-4" ${item.done ? 'checked' : ''}>
                            <span class="flex-grow ${item.done ? 'shopping-item-done' : ''} font-medium">${item.name}</span>
                            <input type="number" step="0.01" value="${item.price || ''}" placeholder="$0.00" class="w-20 text-right border-gray-300 rounded-lg shadow-sm p-2 border text-sm">
                        </div>`).join('')}
                </div>
            </div>`).join('');

        const total = list.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        const footer = `<div class="flex justify-end font-bold text-lg mt-6 pt-4 border-t border-gray-200">Total: ${total.toFixed(2)}</div>`;
        
        return listHtml + footer;
    },

    renderStoreDetailPage(storeId) {
        currentStoreId = storeId;
        const pageEl = document.getElementById('shopping-page');
        const store = (data.stores || []).find(s => s.id === storeId);
        const storeItems = (data.storeItems || []).filter(item => item.storeId === storeId);
        
        pageEl.innerHTML = `
            <div class="card p-6 rounded-2xl">
                <div class="flex items-center gap-4 mb-6">
                    <button class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg transition-colors" onclick="app.navigate('shopping')">
                        <i class="ph-bold ph-arrow-left text-xl"></i>
                    </button>
                    <h2 class="text-2xl font-bold flex-grow text-gray-800">${store.name}</h2>
                    <button class="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="ui.openModal('stores', '${store.id}')">
                        <i class="ph-bold ph-pencil-simple text-xl"></i>
                    </button>
                </div>
                <p class="text-gray-600 mb-6">Manage your master item list for this store. Click the + button to add items to your shopping list.</p>
                <div id="store-items-list" class="space-y-3">
                    ${storeItems.length ? storeItems.map(item => `
                        <div class="flex justify-between items-center p-4 rounded-xl border hover:border-blue-200 transition-colors">
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500 mt-1">${item.category}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="ui.openModal('storeItems', '${item.id}')">
                                    <i class="ph-bold ph-pencil-simple text-lg"></i>
                                </button>
                                <button class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all duration-300 hover:scale-110" onclick="app.addItemToShoppingList('${item.id}')">
                                    <i class="ph-bold ph-plus text-lg"></i>
                                </button>
                            </div>
                        </div>`).join('') : 
                        `<div class="empty-state p-8 text-center">
                            <i class="ph-bold ph-package text-5xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 text-lg">No items in this store yet</p>
                            <p class="text-gray-400 text-sm mt-2">Add items using the + button</p>
                        </div>`}
                </div>
            </div>`;
    },
    
    renderCalendarPage() {
        const pageEl = document.getElementById('calendar-page');
        pageEl.innerHTML = `<div class="card p-4 rounded-2xl"><div id="calendar-container"></div></div>`;
        const calendarEl = document.getElementById('calendar-container');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
            headerToolbar: { 
                left: 'prev,next today', 
                center: 'title', 
                right: 'dayGridMonth,timeGridWeek,listWeek' 
            },
            events: (data.schedule || []).map(task => ({ 
                id: task.id, 
                title: task.title, 
                start: task.startTime && !task.allDay ? `${task.startDate}T${task.startTime}` : task.startDate, 
                end: task.endTime && !task.allDay ? `${task.startDate}T${task.endTime}` : null, 
                allDay: task.allDay, 
                extendedProps: { person: task.person },
                className: this.getEventColorClass(task.person)
            })),
            eventClick: (info) => ui.openModal('schedule', info.event.id),
            dateClick: (info) => ui.openModal('schedule', null, { startDate: info.dateStr.split('T')[0] })
        });
        calendar.render();
    },

    getEventColorClass(person) {
        const colorClasses = {
            'Dad': 'bg-blue-100 border-l-4 border-blue-500 text-blue-800',
            'Mom': 'bg-pink-100 border-l-4 border-pink-500 text-pink-800',
            'Leo': 'bg-green-100 border-l-4 border-green-500 text-green-800'
        };
        return colorClasses[person] || 'bg-gray-100 border-l-4 border-gray-500 text-gray-800';
    },

    renderHealthPage() {
        const pageEl = document.getElementById('health-page');
        const healthItems = data.health || [];
        
        pageEl.innerHTML = `
            <div class="card p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Health & Medications</h2>
                <div class="space-y-3">
                    ${healthItems.length ? healthItems.map(item => this.createHealthListItem(item)).join('') :
                        `<div class="empty-state p-8 text-center">
                            <i class="ph-bold ph-first-aid-kit text-5xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 text-lg">No health items tracked</p>
                            <p class="text-gray-400 text-sm mt-2">Add medications or health reminders</p>
                        </div>`
                    }
                </div>
            </div>`;
    },

    createHealthListItem(med) {
        const formatTime = (t) => t ? new Date(`1970-01-01T${t}`).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : 'No time set';
        const getPersonBadgeClass = (p) => {
            const classes = {
                'Dad': 'bg-blue-100 text-blue-800',
                'Mom': 'bg-pink-100 text-pink-800',
                'Leo': 'bg-green-100 text-green-800'
            };
            return classes[p] || 'bg-gray-100 text-gray-800';
        };

        return `
            <div class="list-item p-4 rounded-xl" data-id="${med.id}" data-type="health">
                <div class="flex items-center w-full">
                    <div class="icon-container">
                        <i class="ph-bold ph-pill text-xl text-red-500"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${med.name}</p>
                        <p class="text-sm text-gray-500">${med.dosage} â€¢ ${formatTime(med.time)}</p>
                    </div>
                    <span class="person-badge ${getPersonBadgeClass(med.person)} ml-3">${med.person}</span>
                </div>
            </div>`;
    },

    renderMealsPage() {
        const pageEl = document.getElementById('meals-page');
        const meals = data.meals || [];
        const groupedMeals = groupBy(meals, 'date');
        const sortedDates = Object.keys(groupedMeals).sort();
        
        pageEl.innerHTML = `
            <div class="card p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Meal Planning</h2>
                <div class="space-y-6">
                    ${sortedDates.length ? sortedDates.map(date => `
                        <div>
                            <h3 class="font-bold text-gray-700 mb-3">${new Date(date + 'T12:00:00').toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                month: 'long', 
                                day: 'numeric' 
                            })}</h3>
                            <div class="space-y-2">
                                ${groupedMeals[date].sort((a, b) => {
                                    const order = { 'Breakfast': 1, 'Lunch': 2, 'Dinner': 3, 'Snack': 4 };
                                    return (order[a.label] || 5) - (order[b.label] || 5);
                                }).map(meal => this.createMealListItem(meal)).join('')}
                            </div>
                        </div>`).join('') :
                        `<div class="empty-state p-8 text-center">
                            <i class="ph-bold ph-fork-knife text-5xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 text-lg">No meals planned yet</p>
                            <p class="text-gray-400 text-sm mt-2">Start planning your family's meals</p>
                        </div>`
                    }
                </div>
            </div>`;
    },

    renderContactsPage() {
        const pageEl = document.getElementById('contacts-page');
        const contacts = data.contacts || [];
        
        pageEl.innerHTML = `
            <div class="card p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Family Contacts</h2>
                <div class="space-y-3">
                    ${contacts.length ? contacts.map(contact => this.createContactListItem(contact)).join('') :
                        `<div class="empty-state p-8 text-center">
                            <i class="ph-bold ph-users text-5xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 text-lg">No contacts added yet</p>
                            <p class="text-gray-400 text-sm mt-2">Add family members and important contacts</p>
                        </div>`
                    }
                </div>
            </div>`;
    },

    createContactListItem(contact) {
        const getBirthdayText = (birthday) => {
            if (!birthday) return 'No birthday set';
            const birthDate = new Date(birthday + 'T12:00:00');
            const today = new Date();
            const thisYearBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
            const age = today.getFullYear() - birthDate.getFullYear();
            const daysUntil = Math.ceil((thisYearBirthday - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntil === 0) return `ðŸŽ‚ Today! (${age} years old)`;
            if (daysUntil > 0 && daysUntil <= 30) return `${daysUntil} days until birthday (turning ${age + 1})`;
            return `${birthDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} (age ${age})`;
        };

        return `
            <div class="list-item p-4 rounded-xl" data-id="${contact.id}" data-type="contacts">
                <div class="flex items-center w-full">
                    <div class="icon-container">
                        <i class="ph-bold ph-user text-xl text-purple-500"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${contact.name}</p>
                        <p class="text-sm text-gray-500">${getBirthdayText(contact.birthday)}</p>
                    </div>
                </div>
            </div>`;
    },

    getUpcomingBirthdays() {
        const today = new Date();
        today.setHours(0,0,0,0);
        const upcoming = [];
        (data.contacts || []).forEach(contact => {
            if (!contact.birthday) return;
            const birthDate = new Date(contact.birthday + 'T12:00:00');
            const thisYearBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
            if (thisYearBirthday >= today && (thisYearBirthday - today) / (1000 * 60 * 60 * 24) <= 30) {
                upcoming.push({
                    id: contact.id, 
                    title: `${contact.name}'s Birthday`, 
                    person: contact.name,
                    startDate: toISODate(thisYearBirthday), 
                    allDay: true, 
                    category: 'Birthday'
                });
            }
        });
        return upcoming;
    }
};

// App Logic
const app = {
    navigate(pageId) {
        currentStoreId = null;
        currentPageId = pageId;
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(`${pageId}-page`).classList.remove('hidden');
        document.querySelectorAll('.nav-icon').forEach(b => b.classList.remove('active'));
        document.querySelector(`.nav-icon[data-page="${pageId}"]`).classList.add('active');
        ui.refreshUI();
    },

    handleAddItem() {
        const pageToAction = { 
            'shopping': 'stores', 
            'calendar': 'schedule', 
            'meals': 'meals', 
            'health': 'health', 
            'contacts': 'contacts' 
        };
        if (currentPageId === 'shopping' && currentStoreId) return ui.openModal('storeItems');
        const action = pageToAction[currentPageId];
        if(action) ui.openModal(action);
        else ui.openModal('schedule');
    },
    
    handleMainContentClick(e) {
        const listItem = e.target.closest('.list-item[data-id]');
        if (listItem) return ui.openModal(listItem.dataset.type, listItem.dataset.id);
        
        const storeCard = e.target.closest('[data-store-id]');
        if (storeCard) return ui.renderStoreDetailPage(storeCard.dataset.storeId);

        const pageNav = e.target.closest('[data-page-nav]');
        if(pageNav) return this.navigate(pageNav.dataset.pageNav);

        const shoppingItemCheckbox = e.target.closest('[data-item-id] input[type="checkbox"]');
        if(shoppingItemCheckbox) {
            const itemId = shoppingItemCheckbox.closest('[data-item-id]').dataset.itemId;
            const item = data.shoppingList.find(i => i.id === itemId);
            if(item) {
                item.done = shoppingItemCheckbox.checked;
                ui.refreshUI();
            }
        }
        
        const shoppingItemPrice = e.target.closest('[data-item-id] input[type="number"]');
        if(shoppingItemPrice) {
            shoppingItemPrice.onblur = () => {
                const itemId = shoppingItemPrice.closest('[data-item-id]').dataset.itemId;
                const item = data.shoppingList.find(i => i.id === itemId);
                if(item) {
                    item.price = parseFloat(shoppingItemPrice.value) || null;
                    ui.refreshUI();
                }
            }
        }
    },

    handleFormSubmit(e) {
        e.preventDefault();
        const type = ui.modal.dataset.type;
        const id = ui.modal.dataset.id;
        let itemData;

        switch(type) {
            case 'schedule': 
                itemData = { 
                    title: document.getElementById('edit-title').value, 
                    person: document.getElementById('edit-person').value, 
                    category: document.getElementById('edit-category').value, 
                    startDate: document.getElementById('edit-start-date').value, 
                    allDay: document.getElementById('edit-all-day').checked, 
                    startTime: document.getElementById('edit-start-time').value, 
                    endTime: document.getElementById('edit-end-time').value 
                }; 
                break;
            case 'stores': 
                itemData = { 
                    name: document.getElementById('edit-store-name').value 
                }; 
                break;
            case 'storeItems': 
                itemData = { 
                    name: document.getElementById('edit-item-name').value, 
                    category: document.getElementById('edit-item-category').value, 
                    storeId: currentStoreId 
                }; 
                break;
            case 'health': 
                itemData = { 
                    person: document.getElementById('edit-health-person').value, 
                    name: document.getElementById('edit-health-name').value, 
                    dosage: document.getElementById('edit-health-dosage').value, 
                    time: document.getElementById('edit-health-time').value 
                }; 
                break;
            case 'meals': 
                itemData = { 
                    date: document.getElementById('edit-meal-date').value, 
                    label: document.getElementById('edit-meal-label').value, 
                    title: document.getElementById('edit-meal-title').value 
                }; 
                break;
            case 'contacts': 
                itemData = { 
                    name: document.getElementById('edit-contact-name').value, 
                    birthday: document.getElementById('edit-contact-birthday').value 
                }; 
                break;
        }
        
        if (itemData) {
            if (id && id !== 'null') {
                // Update existing item
                const item = data[type].find(i => i.id === id);
                if (item) Object.assign(item, itemData);
            } else {
                // Add new item
                itemData.id = generateId();
                if (!data[type]) data[type] = [];
                data[type].push(itemData);
            }
        }
        ui.closeModal();
        ui.refreshUI();
    },
    
    handleDelete() {
        if (!confirm('Are you sure you want to delete this item?')) return;
        const type = ui.modal.dataset.type;
        const id = ui.modal.dataset.id;
        if (id && data[type]) {
            data[type] = data[type].filter(item => item.id !== id);
            ui.closeModal();
            ui.refreshUI();
        }
    },

    addItemToShoppingList(storeItemId) {
        const item = (data.storeItems || []).find(i => i.id === storeItemId);
        if (item) {
            const existing = (data.shoppingList || []).find(i => i.storeItemId === storeItemId);
            if (!existing) {
                if (!data.shoppingList) data.shoppingList = [];
                data.shoppingList.push({
                    id: generateId(),
                    name: item.name,
                    category: item.category,
                    done: false,
                    price: null,
                    storeItemId: item.id,
                    storeId: item.storeId
                });
                ui.refreshUI();
            }
        }
    },
    
    clearShoppingList() {
        if(confirm('Are you sure you want to clear the entire active shopping list?')) {
            data.shoppingList = [];
            ui.refreshUI();
        }
    }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', () => {
    ui.init();
    app.navigate('hub');
});
</script>
</body>
</html> 
