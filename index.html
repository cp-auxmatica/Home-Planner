<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Hub - Interactive Dashboard & Stores</title>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    
    <!-- PWA additions -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff"/>
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root[data-theme="homenexus-light"] {
            --primary: #030213;
            --primary-content: oklch(1 0 0);
            --secondary: oklch(0.95 0.0058 264.53);
            --secondary-content: #030213;
            --accent: #e9ebef;
            --accent-content: #030213;
            --neutral: #717182;
            --base-100: #ffffff;
            --base-200: #f8fafc;
            --base-300: #e9ebef;
            --base-content: oklch(0.145 0 0);
            --info: oklch(0.6 0.118 184.704);
            --success: oklch(0.828 0.189 84.429);
            --warning: oklch(0.769 0.188 70.08);
            --error: #d4183d;
            --rounded-box: 0.625rem;
            --rounded-btn: 0.5rem;
            --border-color: rgba(0, 0, 0, 0.1);
            --bc: var(--border-color);
        }

        :root[data-theme="homenexus-dark"] {
            --primary: oklch(0.985 0 0);
            --primary-content: oklch(0.205 0 0);
            --secondary: oklch(0.269 0 0);
            --secondary-content: oklch(0.985 0 0);
            --accent: oklch(0.269 0 0);
            --accent-content: oklch(0.985 0 0);
            --neutral: oklch(0.708 0 0);
            --base-100: oklch(0.145 0 0);
            --base-200: #030213;
            --base-300: oklch(0.269 0 0);
            --base-content: oklch(0.985 0 0);
            --info: oklch(0.696 0.17 162.48);
            --success: oklch(0.769 0.188 70.08);
            --warning: oklch(0.645 0.246 16.439);
            --error: oklch(0.637 0.237 25.331);
            --rounded-box: 0.625rem;
            --rounded-btn: 0.5rem;
            --border-color: oklch(0.269 0 0);
            --bc: var(--border-color);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: var(--base-200);
        }
        
        .fc-event { cursor: pointer; }
        .toast { z-index: 1000; }
        
        .fc .fc-toolbar.fc-header-toolbar { 
            flex-direction: column; 
            align-items: center; 
            gap: 0.5rem; 
        }
        
        @media (min-width: 768px) { 
            .fc .fc-toolbar.fc-header-toolbar { 
                flex-direction: row; 
            } 
        }
        
        .fc { 
            --fc-border-color: var(--border-color);
            --fc-page-bg-color: var(--base-100);
            --fc-event-bg-color: #3b82f6; 
            --fc-event-border-color: #2563eb; 
            --fc-today-bg-color: rgba(59, 130, 246, 0.1); 
        }
        
        .fc .fc-button-primary { 
            background-color: #2563eb; 
            border-color: #2563eb; 
        }
        
        .fc .fc-button-primary:hover { 
            background-color: #1d4ed8; 
            border-color: #1d4ed8; 
        }
        
        .fc-bg-event { opacity: 0.3 !important; }

        .input:focus, .select:focus, .textarea:focus {
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--p) 15%, transparent);
            border-color: var(--p);
            outline: none;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--neutral);
        }
        
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.3;
            display: block;
        }

    </style>
</head>
<body class="min-h-screen">

    <header class="navbar bg-base-100 shadow-sm sticky top-0 z-40 border-b border-base-300">
        <div class="container mx-auto px-4">
            <div class="navbar-start">
                <h1 class="text-xl md:text-2xl font-bold text-base-content">
                    <i class="fas fa-home mr-2 text-primary"></i> Home Hub
                </h1>
            </div>
            <div class="navbar-end space-x-2">
                <button class="btn btn-ghost btn-circle" onclick="document.getElementById('manage_modal').showModal()">
                    <i class="fas fa-cog text-xl text-base-content/50"></i>
                </button>
                <button class="btn btn-primary btn-sm md:btn-md" onclick="ui.openTaskModal()">
                    <i class="fas fa-plus md:mr-2"></i>
                    <span class="hidden md:inline">New Event</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-7xl">
        <div class="tabs tabs-boxed mb-6" id="viewTabs">
            <a role="tab" class="tab tab-active" data-view="dashboard">
                <i class="fas fa-tachometer-alt mr-2"></i>
                <span class="hidden sm:inline">Dashboard</span>
            </a>
            <a role="tab" class="tab" data-view="mealplanner">
                <i class="fas fa-utensils mr-2"></i>
                <span class="hidden sm:inline">Meals</span>
            </a>
            <a role="tab" class="tab" data-view="grocerylist">
                <i class="fas fa-shopping-cart mr-2"></i>
                <span class="hidden sm:inline">Groceries</span>
            </a>
            <a role="tab" class="tab" data-view="history">
                <i class="fas fa-history mr-2"></i>
                <span class="hidden sm:inline">History</span>
            </a>
            <a role="tab" class="tab" data-view="fullschedule">
                <i class="fas fa-calendar-alt mr-2"></i>
                <span class="hidden sm:inline">Schedule</span>
            </a>
        </div>

        <div id="app-views">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view">
                <!-- Quick Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="stat-card card">
                        <div class="stat-number" id="today-events-count">0</div>
                        <div class="stat-label">Today's Events</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-number" id="pending-chores-count">0</div>
                        <div class="stat-label">Pending Chores</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-number" id="grocery-items-count">0</div>
                        <div class="stat-label">Grocery Items</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-number" id="planned-meals-count">0</div>
                        <div class="stat-label">This Week's Meals</div>
                    </div>
                </div>

                <!-- Main Dashboard Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card bg-base-100">
                        <div class="card-body">
                            <h2 class="card-title text-lg">
                                <i class="fas fa-clock text-info mr-2"></i>Today's Schedule
                            </h2>
                            <div id="today-schedule-widget" class="space-y-2 mt-2"></div>
                        </div>
                    </div>

                    <div class="card bg-base-100 hover:shadow-md cursor-pointer" onclick="ui.switchView('grocerylist')">
                        <div class="card-body">
                            <h2 class="card-title text-lg">
                                <i class="fas fa-shopping-cart text-success mr-2"></i>Active Grocery List
                            </h2>
                            <div id="grocery-list-widget" class="space-y-1 mt-2"></div>
                        </div>
                    </div>

                    <div class="card bg-base-100">
                        <div class="card-body">
                            <h2 class="card-title text-lg" id="dinner-widget-title">
                                <i class="fas fa-drumstick-bite text-warning mr-2"></i>What's for Dinner?
                            </h2>
                            <div id="dinner-widget" class="mt-3"></div>
                        </div>
                    </div>

                    <div class="card bg-base-100">
                        <div class="card-body">
                            <h2 class="card-title text-lg">
                                <i class="fas fa-tasks text-accent-content mr-2"></i>Today's Chores
                            </h2>
                            <div id="today-chores-widget" class="space-y-2 mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meal Planner View -->
            <div id="mealplanner-view" class="view hidden">
                <div class="card bg-base-100 mb-6">
                    <div class="card-body">
                        <details class="collapse collapse-arrow bg-base-200 rounded-xl">
                            <summary class="collapse-title text-lg font-medium">Plan a New Meal</summary>
                            <div class="collapse-content">
                                <form id="meal-page-form" class="space-y-4 pt-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <input type="date" id="meal-page-date" class="input input-bordered w-full" required />
                                        <select id="meal-page-type" class="select select-bordered w-full" required>
                                            <option>Breakfast</option>
                                            <option>Lunch</option>
                                            <option>Dinner</option>
                                        </select>
                                    </div>
                                    <input type="text" id="meal-page-recipeName" class="input input-bordered w-full" placeholder="Recipe Name" required />
                                    <div class="text-right">
                                        <button type="submit" class="btn btn-primary">Save Meal & Open Editor</button>
                                    </div>
                                </form>
                            </div>
                        </details>
                    </div>
                </div>
                <div id="meal-planner-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </div>

            <!-- Grocery List View -->
            <div id="grocerylist-view" class="view hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card bg-base-100">
                    <div class="card-body">
                        <div id="active-list-header"></div>
                        <div id="shopping-list-container" class="space-y-3 mt-4 max-h-96 overflow-y-auto pr-2"></div>
                        <div id="active-list-footer" class="hidden">
                            <div class="divider"></div>
                            <div class="flex justify-between items-center font-bold text-lg">
                                <span>Total:</span>
                                <span id="shopping-list-total" class="text-success">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bg-base-100">
                    <div class="card-body">
                        <h2 class="card-title">My Stores</h2>
                        <form id="add-store-form" class="join w-full mt-4">
                            <input type="text" id="new-store-name" placeholder="Add a new store..." class="input input-bordered join-item flex-1" required />
                            <button type="submit" class="btn btn-primary join-item">Add</button>
                        </form>
                        <div id="stores-container" class="mt-6 space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- History View -->
            <div id="history-view" class="view hidden">
                <div class="card bg-base-100">
                    <div class="card-body">
                        <h2 class="card-title">Shopping Trip History</h2>
                        <div id="trip-history-container" class="space-y-4 mt-6"></div>
                    </div>
                </div>
            </div>

            <!-- Full Schedule View -->
            <div id="fullschedule-view" class="view hidden">
                <div class="card bg-base-100 p-4">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="toast toast-top toast-center" id="toast-container"></div>

    <!-- Modals -->
    <dialog id="task_modal" class="modal">
        <div class="modal-box w-11/12 max-w-lg">
            <h3 class="font-bold text-lg mb-4" id="task-modal-title">New Event</h3>
            <form id="task-form" class="space-y-4">
                <input type="hidden" id="taskId">
                <input type="text" id="taskName" class="input input-bordered w-full" placeholder="Event Name" required />
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <select id="taskType" class="select select-bordered" required>
                        <option disabled selected>Event Type</option>
                        <option>Appointment</option>
                        <option>Meeting</option>
                        <option>Work Schedule</option>
                        <option>Chore</option>
                        <option>Errand</option>
                        <option>Time Off</option>
                    </select>
                    <select id="taskAssignee" class="select select-bordered">
                        <option disabled selected>Assign To</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="date" id="taskDueDate" class="input input-bordered" />
                    <input type="time" id="taskDueTime" class="input input-bordered" />
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="form-control">
                        <label class="cursor-pointer label">
                            <span class="label-text">Recurring?</span>
                            <input type="checkbox" id="taskIsRecurring" class="toggle toggle-primary ml-2" />
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="cursor-pointer label">
                            <span class="label-text">Completed?</span>
                            <input type="checkbox" id="taskIsDone" class="checkbox checkbox-success ml-2" />
                        </label>
                    </div>
                </div>
                
                <div id="recurring-options" class="hidden">
                    <label class="label">
                        <span class="label-text">Repeats on:</span>
                    </label>
                    <div class="join w-full" id="recurring-day-picker">
                        <button type="button" class="join-item btn btn-sm flex-1" data-day="1">M</button>
                        <button type="button" class="join-item btn btn-sm flex-1" data-day="2">T</button>
                        <button type="button" class="join-item btn btn-sm flex-1" data-day="3">W</button>
                        <button type="button" class="join-item btn btn-sm flex-1" data-day="4">T</button>
                        <button type="button" class="join-item btn btn-sm flex-1" data-day="5">F</button>
                        <button type="button" class="join-item btn btn-sm flex-1" data-day="6">S</button>
                        <button type="button" class="join-item btn btn-sm flex-1" data-day="0">S</button>
                    </div>
                </div>
                
                <textarea id="taskNotes" class="textarea textarea-bordered w-full" placeholder="Notes..."></textarea>
                
                <div class="modal-action">
                    <button type="button" class="btn" onclick="document.getElementById('task_modal').close()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Event</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <dialog id="edit_recurring_modal" class="modal">
        <div class="modal-box w-11/12 max-w-xs text-center">
            <h3 class="font-bold text-lg">Edit Recurring Event</h3>
            <p class="py-4">Do you want to change only this event, or this and all future events in the series?</p>
            <div class="modal-action justify-center">
                <button class="btn" id="edit-single-event-btn">Only This Event</button>
                <button class="btn btn-primary" id="edit-future-events-btn">Future Events</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <dialog id="meal_modal" class="modal">
        <div class="modal-box w-11/12 max-w-lg">
            <h3 class="font-bold text-lg" id="meal-modal-title">Edit Meal</h3>
            <form id="meal-form" class="space-y-4 mt-4">
                <input type="hidden" id="mealId">
                <input type="hidden" id="mealDate">
                <input type="hidden" id="mealType">
                <input type="text" id="recipeName" class="input input-bordered w-full" placeholder="Recipe Name" required />
                <input type="url" id="recipeURL" class="input input-bordered w-full" placeholder="https://example.com/recipe" />
                <div class="divider">Ingredients</div>
                <div id="ingredient-list-container" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                <div class="join w-full">
                    <input type="text" id="new-ingredient-name" placeholder="Add an ingredient" class="input input-bordered join-item w-full" />
                    <button type="button" id="add-ingredient-button" class="btn btn-secondary join-item">Add</button>
                </div>
                <div class="modal-action">
                    <button type="button" id="delete-meal-btn" class="btn btn-error mr-auto" onclick="app.handleDeleteMeal()">Delete</button>
                    <button type="button" class="btn" onclick="document.getElementById('meal_modal').close()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <dialog id="manage_modal" class="modal">
        <div class="modal-box w-11/12 max-w-lg">
            <h3 class="font-bold text-lg">Manage Data & Family</h3>
            <div class="mt-6">
                <h4 class="font-semibold text-md">Family Members</h4>
                <div id="family-member-list" class="mt-2 space-y-2"></div>
                <form id="add-family-member-form" class="flex gap-2 mt-2">
                    <input type="text" id="new-member-name" placeholder="New member name" class="input input-bordered w-full" required />
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>

            <div class="divider"></div>
            <div class="mt-4">
                <h4 class="font-semibold text-md">Theme</h4>
                <select id="theme-switcher" class="select select-bordered w-full mt-2">
                    <option value="homenexus-light">Light</option>
                    <option value="homenexus-dark">Dark</option>
                    <option value="system">System Default</option>
                </select>
            </div>
            
            <div class="divider"></div>
            
            <div class="mt-4">
                <h4 class="font-semibold text-md">Backup & Restore</h4>
                <p class="text-sm text-gray-500">Export or import your data. This is a local backup and will not affect cloud data.</p>
                <div class="flex gap-4 mt-4">
                    <button class="btn btn-secondary flex-1" onclick="app.exportData()">Export</button>
                    <label class="btn btn-accent flex-1">
                        Import
                        <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="app.importData(event)" />
                    </label>
                </div>
                
                <div class="divider">DANGER ZONE</div>
                <button class="btn btn-error w-full" onclick="app.clearAllData()">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Clear All Cloud Data
                </button>
            </div>
            
            <div class="modal-action">
                <button type="button" class="btn" onclick="document.getElementById('manage_modal').close()">Close</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

<script type="module">
// --- FIREBASE IMPORTS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- GLOBAL CONFIG & STATE ---
const OBJECT_STORES = ['tasks', 'meals', 'groceries', 'familyMembers', 'shoppingTrips', 'stores', 'storeItems'];
let fb_db, fb_auth, userId;
let unsubscribes = []; // To hold snapshot listeners

// --- Your web app's Firebase configuration ---
const providedFirebaseConfig = {
  apiKey: "AIzaSyBByUjZqNeA6k6p8PeeoUFENRTZLkjeT6s",
  authDomain: "home-planner-ce48b.firebaseapp.com",
  projectId: "home-planner-ce48b",
  storageBucket: "home-planner-ce48b.firebasestorage.app",
  messagingSenderId: "20103999017",
  appId: "1:20103999017:web:9be545d5a0f70008dc7638"
};

/**
 * =================================================================
 * THEME MANAGER
 * =================================================================
 */
const themeManager = {
    init() {
        const selector = document.getElementById('theme-switcher');
        selector.addEventListener('change', (e) => this.setTheme(e.target.value));

        const savedTheme = localStorage.getItem('theme') || 'system';
        selector.value = savedTheme;
        this.setTheme(savedTheme);

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (localStorage.getItem('theme') === 'system') {
                this.applySystemTheme();
            }
        });
    },
    setTheme(theme) {
        localStorage.setItem('theme', theme);
        if (theme === 'system') {
            this.applySystemTheme();
        } else {
            document.documentElement.setAttribute('data-theme', theme);
        }
    },
    applySystemTheme() {
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'homenexus-dark' : 'homenexus-light';
        document.documentElement.setAttribute('data-theme', systemTheme);
    }
};


/**
 * =================================================================
 * DATABASE MODULE (db) - Firestore Implementation
 * =================================================================
 */
const db = {
    _getCollectionPath: (storeName) => {
        if (!userId) throw new Error("User not authenticated.");
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        return `artifacts/${appId}/users/${userId}/${storeName}`;
    },
    add: (storeName, item) => addDoc(collection(fb_db, db._getCollectionPath(storeName)), item),
    get: (storeName, id) => getDoc(doc(fb_db, db._getCollectionPath(storeName), id)),
    getAll: async (storeName) => { const snapshot = await getDocs(collection(fb_db, db._getCollectionPath(storeName))); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); },
    update: (storeName, id, item) => updateDoc(doc(fb_db, db._getCollectionPath(storeName), id), item),
    set: (storeName, id, item) => setDoc(doc(fb_db, db._getCollectionPath(storeName), id), item),
    delete: (storeName, id) => deleteDoc(doc(fb_db, db._getCollectionPath(storeName), id)),
    query: async (storeName, field, op, value) => { const q = query(collection(fb_db, db._getCollectionPath(storeName)), where(field, op, value)); const snapshot = await getDocs(q); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); },
    clear: async (storeName) => { const allItems = await db.getAll(storeName); const batch = writeBatch(fb_db); allItems.forEach(item => batch.delete(doc(fb_db, db._getCollectionPath(storeName), item.id))); await batch.commit(); }
};

/**
 * =================================================================
 * UI MODULE (ui)
 * =================================================================
 */
const ui = {
    currentView: 'dashboard', calendar: null,
    init() { this.setupTabs(); },
    setupTabs() { document.getElementById('viewTabs').addEventListener('click', (e) => { const tab = e.target.closest('a[role="tab"]'); if (tab) this.switchView(tab.dataset.view); }); },
    switchView(viewName) { 
        this.currentView = viewName; 
        document.querySelectorAll('#viewTabs .tab').forEach(tab => tab.classList.toggle('tab-active', tab.dataset.view === viewName)); 
        document.querySelectorAll('#app-views .view').forEach(view => view.classList.toggle('hidden', view.id !== `${viewName}-view`)); 
        this.renderAll(); 
    },
    renderAll() { 
        switch (this.currentView) { 
            case 'dashboard': this.renderDashboard(); break; 
            case 'mealplanner': this.renderMealPlanner(); break; 
            case 'grocerylist': this.renderGroceryList(); break; 
            case 'history': this.renderHistory(); break; 
            case 'fullschedule': this.renderFullSchedule(); break; 
        } 
        this.renderFamilyMembers(); 
        this.populateAssigneeDropdown(); 
    },

    renderDashboard() {
        const today = new Date(); 
        const todayStr = today.toISOString().split('T')[0]; 
        const dayName = today.toLocaleDateString(undefined, { weekday: 'long' });
        const tasks = (app.data.tasks || []).filter(t => t.status !== 'Done'); 
        const meals = app.data.meals || []; 
        const groceries = (app.data.groceries || []).filter(item => !item.isChecked);

        // Update stats
        const todayEvents = tasks.filter(t => t.dueDate === todayStr && t.type !== 'Chore');
        const todayChores = tasks.filter(t => t.dueDate === todayStr && t.type === 'Chore');
        const nextWeek = new Date();
        nextWeek.setDate(today.getDate() + 7);
        const weekMeals = meals.filter(m => {
            const mealDate = new Date(m.date + "T00:00:00");
            const todayDate = new Date(todayStr + "T00:00:00");
            return mealDate >= todayDate && mealDate <= nextWeek;
        });

        document.getElementById('today-events-count').textContent = todayEvents.length;
        document.getElementById('pending-chores-count').textContent = todayChores.length;
        document.getElementById('grocery-items-count').textContent = groceries.length;
        document.getElementById('planned-meals-count').textContent = weekMeals.length;

        // Today's Schedule
        const scheduleContainer = document.getElementById('today-schedule-widget');
        const sortedEvents = todayEvents.sort((a,b) => (a.dueTime || '').localeCompare(b.dueTime || ''));
        
        if (sortedEvents.length === 0) {
            scheduleContainer.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-check"></i><p>No events scheduled today.</p></div>';
        } else {
            scheduleContainer.innerHTML = sortedEvents.map(t => `
                <div class="dashboard-item p-3 cursor-pointer" onclick="ui.openTaskModal('${t.id}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-semibold">${t.name}</span>
                            ${t.assignee ? `<span class="text-sm text-base-content/70 ml-2">${t.assignee}</span>` : ''}
                        </div>
                        <div class="badge ${app.getEventTypeColor(t.type,'badge')}">
                            ${t.dueTime || t.type}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Today's Chores
        const choresContainer = document.getElementById('today-chores-widget');
        if (todayChores.length === 0) {
            choresContainer.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No chores due today!</p></div>';
        } else {
            choresContainer.innerHTML = todayChores.map(t => `
                <div class="dashboard-item p-3 cursor-pointer" onclick="ui.openTaskModal('${t.id}')">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold">${t.name}</span>
                        ${t.assignee ? `<span class="badge badge-ghost">${t.assignee}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Dinner Widget
        const dinnerWidgetTitle = document.getElementById('dinner-widget-title'); 
        const dinnerContainer = document.getElementById('dinner-widget'); 
        const tonightDinner = meals.find(m => m.date === todayStr && m.mealType === 'Dinner');
        
        dinnerWidgetTitle.innerHTML = `<i class="fas fa-drumstick-bite text-warning mr-2"></i>${dayName}'s Dinner`;
        
        if (tonightDinner) { 
            dinnerContainer.innerHTML = `
                <div class="dashboard-item p-3 cursor-pointer" onclick="ui.openMealModal('${tonightDinner.date}', '${tonightDinner.mealType}', '${tonightDinner.id}')">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold">${tonightDinner.recipeName}</span>
                        <div class="badge badge-warning">Dinner</div>
                    </div>
                </div>
                ${tonightDinner.recipeURL ? `<a href="${tonightDinner.recipeURL}" target="_blank" class="link link-primary text-sm mt-3 block">View Recipe</a>` : ''}
            `; 
        } else { 
            dinnerContainer.innerHTML = '<div class="empty-state"><i class="fas fa-utensils"></i><p>Not planned yet.</p></div>'; 
        }

        // Grocery Widget
        const groceryWidget = document.getElementById('grocery-list-widget'); 
        if (groceries.length === 0) { 
            groceryWidget.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Your shopping list is empty.</p></div>'; 
        } else { 
            groceryWidget.innerHTML = groceries.slice(0, 4).map(item => `
                <div class="text-sm py-1 border-l-2 border-base-300 pl-3">${item.itemName}</div>
            `).join('') + (groceries.length > 4 ? `
                <div class="text-primary text-sm mt-3 font-semibold">+ ${groceries.length - 4} more items</div>
            ` : ''); 
        }
    },
    
    renderGroceryList() {
        const shoppingList = app.data.groceries || []; 
        const activeListHeader = document.getElementById('active-list-header'); 
        const activeListFooter = document.getElementById('active-list-footer'); 
        const shoppingContainer = document.getElementById('shopping-list-container');
        
        if (app.activeStore) { 
            activeListHeader.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h2 class="card-title">Shopping at: ${app.activeStore.name}</h2>
                    <button class="btn btn-success btn-sm" onclick="app.handleCompleteShoppingTrip()">
                        <i class="fas fa-check-circle mr-2"></i>Complete Trip
                    </button>
                </div>
            `; 
            
            if (shoppingList.length === 0) {
                shoppingContainer.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-basket"></i><p>Add items from your stores to begin shopping.</p></div>';
            } else {
                shoppingContainer.innerHTML = shoppingList.map(item => `
                    <div class="shopping-item flex items-center gap-3 group" id="shopping-item-${item.id}">
                        <input type="checkbox" data-id="${item.id}" ${item.isChecked ? 'checked' : ''} 
                               class="checkbox checkbox-primary shopping-item-checkbox" />
                        <div class="flex-grow ${item.isChecked ? 'line-through text-base-content/50' : ''} shopping-item-name">
                            ${item.itemName}
                        </div>
                        <input type="number" step="0.01" placeholder="0.00" value="${item.price || ''}" 
                               data-id="${item.id}" class="input input-xs input-bordered w-20 text-right shopping-item-price" />
                        <button class="btn btn-xs btn-ghost text-base-content/40 opacity-0 group-hover:opacity-100" 
                                onclick="app.toggleEditShoppingItem('${item.id}')">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="btn btn-xs btn-ghost text-error" onclick="app.handleRemoveFromShoppingList('${item.id}')">&times;</button>
                    </div>
                `).join('');
            }
            
            const total = shoppingList.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0); 
            document.getElementById('shopping-list-total').textContent = `$${total.toFixed(2)}`; 
            activeListFooter.classList.remove('hidden');
        } else { 
            activeListHeader.innerHTML = `<h2 class="card-title">No Active List</h2>`; 
            shoppingContainer.innerHTML = '<div class="empty-state"><i class="fas fa-store"></i><p>Select a store and add items to begin a shopping trip.</p></div>'; 
            activeListFooter.classList.add('hidden'); 
        }

        // Render Stores
        const stores = app.data.stores || []; 
        const allStoreItems = app.data.storeItems || []; 
        const storesContainer = document.getElementById('stores-container');
        
        if (stores.length === 0) { 
            storesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-store-alt"></i><p>No stores created yet. Add one to get started!</p></div>'; 
        } else { 
            storesContainer.innerHTML = stores.map(store => { 
                const itemsForStore = allStoreItems.filter(item => item.storeId === store.id); 
                return `
                    <details class="collapse collapse-arrow bg-base-200">
                        <summary class="collapse-title text-base font-medium flex justify-between items-center">
                            ${store.name}
                            <button class="btn btn-xs btn-ghost text-error" onclick="event.stopPropagation(); app.deleteStore('${store.id}', '${store.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </summary>
                        <div class="collapse-content">
                            <form class="join w-full my-3" onsubmit="app.addStoreItem(event, '${store.id}')">
                                <input type="text" placeholder="Add item to ${store.name}" 
                                       class="input input-sm input-bordered join-item flex-1" required />
                                <button type="submit" class="btn btn-sm btn-secondary join-item">Add</button>
                            </form>
                            <div class="space-y-2">
                                ${itemsForStore.length > 0 ? itemsForStore.map(item => `
                                    <div class="store-item flex justify-between items-center group" id="store-item-${item.id}">
                                        <div class="store-item-name">${item.itemName}</div>
                                        <div class="flex gap-1">
                                            <button class="btn btn-xs btn-ghost text-base-content/40 opacity-0 group-hover:opacity-100" 
                                                    onclick="app.toggleEditStoreItem('${item.id}')">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button class="btn btn-xs btn-circle btn-primary" onclick="app.handleAddToShoppingList('${item.id}')">+</button>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-xs text-base-content/60 py-2">No items added yet.</p>'}
                            </div>
                        </div>
                    </details>
                `; 
            }).join(''); 
        }
    },
    
    renderHistory() { 
        const container = document.getElementById('trip-history-container'); 
        const trips = app.data.shoppingTrips || []; 
        trips.sort((a, b) => new Date(b.dateCompleted) - new Date(a.dateCompleted)); 
        
        if (trips.length === 0) { 
            container.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>No completed shopping trips found.</p></div>'; 
            return; 
        } 
        
        container.innerHTML = trips.map(trip => `
            <details class="collapse collapse-arrow bg-base-200">
                <summary class="collapse-title text-base font-medium">
                    ${new Date(trip.dateCompleted).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })} - ${trip.storeName || 'Store'}
                    <span class="ml-4 font-bold text-success">$${trip.totalCost.toFixed(2)}</span>
                </summary>
                <div class="collapse-content">
                    <button class="btn btn-sm btn-outline btn-secondary my-3" onclick="app.reuseShoppingTrip('${trip.id}')">
                        <i class="fas fa-redo-alt mr-2"></i>Reuse This List
                    </button>
                    <ul class="list-disc pl-6 space-y-1">
                        ${trip.items.map(item => `
                            <li>
                                <span class="${item.isChecked ? '' : 'line-through text-base-content/50'}">${item.itemName}</span>
                                <span class="ml-2 text-sm font-mono text-base-content/70">${item.price ? '$' + item.price.toFixed(2) : ''}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </details>
        `).join(''); 
    },

    renderFullSchedule() { 
        if (this.calendar) this.calendar.destroy(); 
        const calendarEl = document.getElementById('calendar'); 
        const tasks = app.data.tasks || []; 
        const meals = app.data.meals || []; 
        
        const events = [ 
            ...tasks.map(task => { 
                const eventObj = { 
                    id: `task-${task.id}`, 
                    title: `${task.name} (${task.assignee || 'all'})`, 
                    start: `${task.dueDate}${task.dueTime ? 'T' + task.dueTime : ''}`, 
                    allDay: !task.dueTime, 
                    borderColor: app.getEventTypeColor(task.type, 'calendar'), 
                    className: task.status === 'Done' ? 'opacity-50' : '' 
                }; 
                if (task.type === 'Time Off') { 
                    eventObj.display = 'background'; 
                    eventObj.backgroundColor = app.getEventTypeColor(task.type, 'calendar'); 
                } else { 
                    eventObj.backgroundColor = app.getEventTypeColor(task.type, 'calendar'); 
                } 
                return eventObj; 
            }), 
            ...meals.map(meal => ({ 
                id: `meal-${meal.id}`, 
                title: `${meal.mealType}: ${meal.recipeName}`, 
                start: meal.date, 
                allDay: true, 
                backgroundColor: '#f97316', 
                borderColor: '#ea580c' 
            })) 
        ]; 
        
        this.calendar = new FullCalendar.Calendar(calendarEl, { 
            initialView: 'dayGridMonth', 
            headerToolbar: { 
                left: 'prev,next today', 
                center: 'title', 
                right: 'dayGridMonth,timeGridWeek,listWeek' 
            }, 
            events: events, 
            eventClick: (info) => { 
                const [type, id] = info.event.id.split('-'); 
                if (type === 'task') this.openTaskModal(id); 
                else if (type === 'meal') { 
                    const mealDate = info.event.start.toISOString().split('T')[0]; 
                    const mealType = info.event.title.split(':')[0]; 
                    this.openMealModal(mealDate, mealType, id); 
                } 
            } 
        }); 
        this.calendar.render(); 
    },

    renderMealPlanner() { 
        const container = document.getElementById('meal-planner-grid'); 
        const meals = app.data.meals || []; 
        const mealsByDate = meals.reduce((acc, meal) => { 
            (acc[meal.date] = acc[meal.date] || []).push(meal); 
            return acc; 
        }, {}); 
        const sortedDates = Object.keys(mealsByDate).sort(); 
        
        if (sortedDates.length === 0) {
            container.innerHTML = '<div class="col-span-full empty-state"><i class="fas fa-utensils"></i><p>No meals planned. Add one above to get started.</p></div>';
            return;
        }
        
        container.innerHTML = sortedDates.map(date => `
            <div class="meal-card bg-base-100 p-4">
                <h3 class="font-semibold text-base mb-3">
                    ${new Date(date+'T12:00:00').toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'})}
                </h3>
                <div class="space-y-2">
                    ${['Breakfast', 'Lunch', 'Dinner'].map(type => { 
                        const meal = mealsByDate[date].find(m => m.mealType === type); 
                        return meal ? `
                            <div class="meal-type meal-planned" onclick="ui.openMealModal('${date}', '${type}', '${meal.id}')">
                                <strong>${type}:</strong> ${meal.recipeName}
                            </div>
                        ` : `
                            <div class="meal-type meal-unplanned">
                                <strong>${type}:</strong> Unplanned
                            </div>
                        `; 
                    }).join('')}
                </div>
            </div>
        `).join(''); 
    },

    renderIngredientListItem(ingredient = { name: '', status: 'Need' }) { 
        const container = document.getElementById('ingredient-list-container'); 
        const div = document.createElement('div'); 
        div.className = 'flex items-center gap-2 bg-base-200 p-2 rounded'; 
        div.innerHTML = `
            <label class="flex-grow flex items-center gap-2 cursor-pointer">
                <input type="checkbox" class="checkbox checkbox-sm ingredient-status" ${ingredient.status === 'Need' ? 'checked' : ''} />
                <span class="ingredient-name">${ingredient.name}</span>
            </label>
            <button type="button" class="btn btn-xs btn-ghost text-error ingredient-remove">&times;</button>
        `; 
        div.querySelector('.ingredient-remove').addEventListener('click', () => div.remove()); 
        container.appendChild(div); 
    },

    async openMealModal(date, mealType, id = null) { 
        if (!id) return; 
        const form = document.getElementById('meal-form'); 
        form.reset(); 
        document.getElementById('mealId').value = ''; 
        document.getElementById('mealDate').value = date; 
        document.getElementById('mealType').value = mealType; 
        document.getElementById('ingredient-list-container').innerHTML = ''; 
        
        const mealDoc = await db.get('meals', id); 
        if (!mealDoc.exists()) return; 
        const meal = mealDoc.data(); 
        
        document.getElementById('meal-modal-title').textContent = `Edit: ${meal.recipeName}`; 
        document.getElementById('mealId').value = id; 
        document.getElementById('recipeName').value = meal.recipeName; 
        document.getElementById('recipeURL').value = meal.recipeURL || ''; 
        
        let ingredients = meal.ingredients || []; 
        if (typeof ingredients === 'string') { 
            ingredients = ingredients.split('\n').filter(Boolean).map(name => ({ name, status: 'Need' })); 
        } 
        ingredients.forEach(ing => this.renderIngredientListItem(ing)); 
        
        document.getElementById('meal_modal').showModal(); 
    },

    async openTaskModal(id = null, templateData = null) { 
        const form = document.getElementById('task-form'); 
        form.reset(); 
        document.getElementById('taskId').value = ''; 
        document.getElementById('recurring-options').classList.add('hidden'); 
        document.getElementById('task-modal-title').textContent = 'New Event'; 
        document.querySelectorAll('#recurring-day-picker .btn').forEach(btn => btn.classList.remove('btn-active')); 
        
        if (id) { 
            const taskDoc = await db.get('tasks', id); 
            if (taskDoc.exists()){ 
                const task = taskDoc.data(); 
                document.getElementById('task-modal-title').textContent = 'Edit Event'; 
                document.getElementById('taskId').value = id; 
                document.getElementById('taskName').value = task.name; 
                document.getElementById('taskType').value = task.type; 
                document.getElementById('taskAssignee').value = task.assignee || ''; 
                document.getElementById('taskDueDate').value = task.dueDate || ''; 
                document.getElementById('taskDueTime').value = task.dueTime || ''; 
                document.getElementById('taskIsRecurring').checked = task.isRecurring; 
                document.getElementById('taskIsDone').checked = task.status === 'Done'; 
                document.getElementById('taskNotes').value = task.notes || ''; 
                if (task.isRecurring) { 
                    document.getElementById('recurring-options').classList.remove('hidden'); 
                    if (task.recurringDays) { 
                        task.recurringDays.forEach(day => document.querySelector(`#recurring-day-picker [data-day='${day}']`)?.classList.add('btn-active')); 
                    } 
                } 
            } 
        } else if (templateData) { 
            Object.keys(templateData).forEach(key => { 
                const el = form.querySelector(`#task${key.charAt(0).toUpperCase() + key.slice(1)}`); 
                if(el) el.value = templateData[key]; 
            }); 
            if(templateData.isRecurring) { 
                document.getElementById('taskIsRecurring').checked = true; 
                document.getElementById('recurring-options').classList.remove('hidden'); 
                if(templateData.recurringDays) { 
                    templateData.recurringDays.forEach(day => document.querySelector(`#recurring-day-picker [data-day='${day}']`)?.classList.add('btn-active')); 
                } 
            } 
        } 
        document.getElementById('task_modal').showModal(); 
    },

    renderFamilyMembers() { 
        const members = app.data.familyMembers || []; 
        const container = document.getElementById('family-member-list');
        if (members.length === 0) {
            container.innerHTML = `<p class="text-base-content/70 text-sm">No family members added.</p>`; 
        } else {
            container.innerHTML = members.map(member => `
                <div class="flex justify-between items-center p-2 bg-base-200 rounded">
                    <span>${member.name}</span>
                    <button class="btn btn-xs btn-ghost text-error" onclick="app.deleteFamilyMember('${member.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
    },

    populateAssigneeDropdown() { 
        const members = app.data.familyMembers || []; 
        const select = document.getElementById('taskAssignee'); 
        select.innerHTML = '<option value="">Unassigned</option>'; 
        members.forEach(member => { 
            select.innerHTML += `<option value="${member.name}">${member.name}</option>`; 
        }); 
    },

    showToast(message, type = 'success') { 
        const container = document.getElementById('toast-container'); 
        const toast = document.createElement('div'); 
        const alertType = type === 'success' ? 'alert-success' : 'alert-error'; 
        toast.className = `alert ${alertType} shadow-lg`; 
        toast.innerHTML = `<div><i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i><span>${message}</span></div>`; 
        container.appendChild(toast); 
        setTimeout(() => { toast.remove(); }, 3000); 
    }
};

/**
 * =================================================================
 * APPLICATION MODULE (app)
 * =================================================================
 */
const app = {
    _tempTaskData: null, activeStore: null, data: {},
    init() { ui.init(); this.setupEventListeners(); },
    setupEventListeners() { document.getElementById('task-form').addEventListener('submit', (e) => this.handleTaskFormSubmit(e)); document.getElementById('taskIsRecurring').addEventListener('change', e => document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked)); document.getElementById('recurring-day-picker').addEventListener('click', e => { if(e.target.matches('.btn')) e.target.classList.toggle('btn-active'); }); document.getElementById('meal-form').addEventListener('submit', (e) => this.handleMealModalSubmit(e)); document.getElementById('meal-page-form').addEventListener('submit', (e) => this.handleMealPageFormSubmit(e)); document.getElementById('add-ingredient-button').addEventListener('click', () => this.handleAddIngredient()); document.getElementById('new-ingredient-name').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.handleAddIngredient(); }}); document.getElementById('add-store-form').addEventListener('submit', (e) => this.addStore(e)); document.getElementById('shopping-list-container').addEventListener('change', (e) => this.handleShoppingListUpdate(e)); document.getElementById('edit-single-event-btn').addEventListener('click', () => this.handleEditSingleRecurring()); document.getElementById('edit-future-events-btn').addEventListener('click', () => this.handleEditFutureRecurring()); document.getElementById('add-family-member-form').addEventListener('submit', (e) => this.addFamilyMember(e)); },

    getEventTypeColor(type, context) { const c = { 'Appointment': { badge: 'badge-info', calendar: '#3b82f6' }, 'Meeting': { badge: 'badge-primary', calendar: '#8b5cf6' }, 'Work Schedule': { badge: 'badge-neutral', calendar: '#4b5563' }, 'Chore': { badge: 'badge-success', calendar: '#22c55e' }, 'Errand': { badge: 'badge-warning', calendar: '#f59e0b' }, 'Time Off': {badge: 'badge-error', calendar: 'rgba(239, 68, 68, 0.5)' }, 'default': { badge: 'badge-ghost', calendar: '#6b7280' } }; return (c[type] || c.default)[context]; },
    
    async handleTaskFormSubmit(e) { e.preventDefault(); const taskId = document.getElementById('taskId').value; const isRecurring = document.getElementById('taskIsRecurring').checked; const recurringDays = isRecurring ? Array.from(document.querySelectorAll('#recurring-day-picker .btn-active')).map(btn => parseInt(btn.dataset.day)) : []; if (isRecurring && recurringDays.length === 0) { ui.showToast("Please select at least one day for recurring events.", "error"); return; } const taskData = { name: document.getElementById('taskName').value, type: document.getElementById('taskType').value, assignee: document.getElementById('taskAssignee').value, dueDate: document.getElementById('taskDueDate').value, dueTime: document.getElementById('taskDueTime').value, isRecurring, recurringDays, status: document.getElementById('taskIsDone').checked ? 'Done' : 'To Do', notes: document.getElementById('taskNotes').value, }; if (taskId) { const originalTaskDoc = await db.get('tasks', taskId); const originalTask = originalTaskDoc.data(); if (originalTask.isRecurring) { this._tempTaskData = { ...taskData, id: taskId, originalTask }; document.getElementById('edit_recurring_modal').showModal(); return; } await db.update('tasks', taskId, taskData); ui.showToast('Event updated!'); } else { taskData.seriesId = `series-${Date.now()}`; await db.add('tasks', taskData); if (taskData.isRecurring && taskData.recurringDays.length > 0) { const baseTask = { ...taskData }; let currentDate = new Date(baseTask.dueDate + 'T12:00:00Z'); const endDate = new Date(currentDate); endDate.setDate(endDate.getDate() + 60); const batch = writeBatch(fb_db); while(currentDate < endDate) { currentDate.setDate(currentDate.getDate() + 1); if(baseTask.recurringDays.includes(currentDate.getUTCDay())) { const nextTask = { ...baseTask }; nextTask.dueDate = currentDate.toISOString().split('T')[0]; const docRef = doc(collection(fb_db, db._getCollectionPath('tasks'))); batch.set(docRef, nextTask); } } await batch.commit(); } ui.showToast('Event(s) added!'); } document.getElementById('task_modal').close(); },
    async handleEditSingleRecurring() { if (!this._tempTaskData) return; const taskData = { ...this._tempTaskData }; document.getElementById('edit_recurring_modal').close(); document.getElementById('task_modal').close(); const updateData = { ...taskData, isRecurring: false, recurringDays: [], seriesId: null }; delete updateData.id; delete updateData.originalTask; await db.update('tasks', taskData.id, updateData); ui.showToast("Just this event was updated."); this._tempTaskData = null; },
    async handleEditFutureRecurring() { if (!this._tempTaskData) return; const taskData = { ...this._tempTaskData }; const originalTask = taskData.originalTask; document.getElementById('edit_recurring_modal').close(); document.getElementById('task_modal').close(); const futureEvents = await db.query('tasks', 'seriesId', '==', originalTask.seriesId); const eventsToDelete = futureEvents.filter(t => t.dueDate >= originalTask.dueDate); const batch = writeBatch(fb_db); eventsToDelete.forEach(event => batch.delete(doc(fb_db, db._getCollectionPath('tasks'), event.id))); await batch.commit(); delete taskData.id; delete taskData.originalTask; await db.add('tasks', taskData); if (taskData.isRecurring && taskData.recurringDays.length > 0) { const baseTask = { ...taskData }; let currentDate = new Date(baseTask.dueDate + 'T12:00:00Z'); const endDate = new Date(currentDate); endDate.setDate(endDate.getDate() + 60); const addBatch = writeBatch(fb_db); while(currentDate < endDate) { currentDate.setDate(currentDate.getDate() + 1); if(baseTask.recurringDays.includes(currentDate.getUTCDay())) { const nextTask = { ...baseTask }; nextTask.dueDate = currentDate.toISOString().split('T')[0]; const docRef = doc(collection(fb_db, db._getCollectionPath('tasks'))); addBatch.set(docRef, nextTask); } } await addBatch.commit(); } ui.showToast("This and all future events were updated."); this._tempTaskData = null; },

    // --- Grocery Handlers ---
    async addStore(e) { e.preventDefault(); const nameInput = document.getElementById('new-store-name'); const name = nameInput.value.trim(); if (name) { await db.add('stores', { name }); nameInput.value = ''; ui.showToast("Store added!"); } },
    async deleteStore(id, name) { if (confirm(`Delete store "${name}" and all its master items? This cannot be undone.`)) { await db.delete('stores', id); const itemsToDelete = await db.query('storeItems', 'storeId', '==', id); const batch = writeBatch(fb_db); itemsToDelete.forEach(item => batch.delete(doc(fb_db, db._getCollectionPath('storeItems'), item.id))); await batch.commit(); ui.showToast(`"${name}" deleted.`); } },
    async addStoreItem(e, storeId) { e.preventDefault(); const input = e.target.querySelector('input'); const itemName = input.value.trim(); if(itemName) { await db.add('storeItems', { itemName, storeId, category: 'Uncategorized' }); input.value = ''; } },
    async handleAddToShoppingList(storeItemId) { const itemDoc = await db.get('storeItems', storeItemId); if (!itemDoc.exists()) return; const item = itemDoc.data(); const storeDoc = await db.get('stores', item.storeId); if (!storeDoc.exists()) return; const store = {id: storeDoc.id, ...storeDoc.data()}; if (this.activeStore && this.activeStore.id !== store.id) { if (!confirm(`You have an active list for ${this.activeStore.name}. Clear it and start a new one for ${store.name}?`)) return; await db.clear('groceries'); } this.activeStore = store; if((app.data.groceries || []).some(i => i.itemName.toLowerCase() === item.itemName.toLowerCase())) { return ui.showToast(`${item.itemName} is already on the list.`, 'error'); } await db.add('groceries', { storeId: item.storeId, itemName: item.itemName, isChecked: false, price: null }); },
    async handleCompleteShoppingTrip() { if (!this.activeStore) return; if (app.data.groceries.length === 0) { ui.showToast("Shopping list is empty.", "error"); return; } if (confirm(`Complete trip for ${this.activeStore.name}? This will save it to history and clear the list.`)) { const totalCost = app.data.groceries.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0); const newTrip = { dateCompleted: new Date().toISOString(), items: app.data.groceries, totalCost: totalCost, storeId: this.activeStore.id, storeName: this.activeStore.name }; await db.add('shoppingTrips', newTrip); await db.clear('groceries'); this.activeStore = null; ui.showToast('Shopping trip saved to history!'); } },
    async reuseShoppingTrip(tripId) { if ((app.data.groceries || []).length > 0) { if (!confirm("This will clear your current shopping list. Continue?")) return; } await db.clear('groceries'); const tripDoc = await db.get('shoppingTrips', tripId); if (!tripDoc.exists()) return; const trip = tripDoc.data(); const storeDoc = await db.get('stores', trip.storeId); if (!storeDoc.exists()) { ui.showToast('Cannot find the original store for this trip.', 'error'); return; } this.activeStore = {id: storeDoc.id, ...storeDoc.data()}; const batch = writeBatch(fb_db); for (const item of trip.items) { const newItem = { ...item, isChecked: false, price: null }; const docRef = doc(collection(fb_db, db._getCollectionPath('groceries'))); batch.set(docRef, newItem); } await batch.commit(); ui.showToast(`Loaded list from trip to ${this.activeStore.name}.`); ui.switchView('grocerylist'); },
    toggleEditStoreItem(id) { const itemDiv = document.getElementById(`store-item-${id}`); const nameDiv = itemDiv.querySelector('.store-item-name'); const text = nameDiv.textContent; nameDiv.innerHTML = `<input type="text" value="${text}" class="input input-xs input-bordered w-full/2 grow"><button class="btn btn-xs btn-success" onclick="app.saveStoreItemEdit('${id}')"><i class="fas fa-check"></i></button>`; nameDiv.querySelector('input').focus(); },
    async saveStoreItemEdit(id) { const itemDiv = document.getElementById(`store-item-${id}`); const input = itemDiv.querySelector('input'); const newName = input.value.trim(); if (newName) { await db.update('storeItems', id, { itemName: newName }); } },
    toggleEditShoppingItem(id) { const itemDiv = document.getElementById(`shopping-item-${id}`); const nameDiv = itemDiv.querySelector('.shopping-item-name'); const text = nameDiv.textContent; nameDiv.innerHTML = `<input type="text" value="${text}" class="input input-xs input-bordered w-full/2 grow"><button class="btn btn-xs btn-success" onclick="app.saveShoppingItemEdit('${id}')"><i class="fas fa-check"></i></button>`; nameDiv.querySelector('input').focus(); },
    async saveShoppingItemEdit(id) { const itemDiv = document.getElementById(`shopping-item-${id}`); const input = itemDiv.querySelector('input'); const newName = input.value.trim(); if (newName) { await db.update('groceries', id, { itemName: newName }); } },
    
    // Other handlers
    async handleShoppingListUpdate(e) { const itemId = e.target.dataset.id; if (!itemId) return; const updateData = {}; if (e.target.matches('.shopping-item-checkbox')) { updateData.isChecked = e.target.checked; } else if (e.target.matches('.shopping-item-price')) { updateData.price = parseFloat(e.target.value) || null; } await db.update('groceries', itemId, updateData); },
    async handleRemoveFromShoppingList(id) { if (id) await db.delete('groceries', id); },
    async handleMealModalSubmit(e) { e.preventDefault(); const mealId = document.getElementById('mealId').value; if (!mealId) return; const ingredients = []; document.querySelectorAll('#ingredient-list-container > div').forEach(div => { ingredients.push({ name: div.querySelector('.ingredient-name').textContent, status: div.querySelector('.ingredient-status').checked ? 'Need' : 'Have' }); }); const mealData = { date: document.getElementById('mealDate').value, mealType: document.getElementById('mealType').value, recipeName: document.getElementById('recipeName').value, recipeURL: document.getElementById('recipeURL').value, ingredients }; await db.set('meals', mealId, mealData); const meal = {...mealData, id: mealId}; const addedToGrocery = await this.addNeededIngredientsToGroceries(meal); let toastMessage = 'Meal saved!'; if(addedToGrocery > 0) toastMessage += ` Added ${addedToGrocery} item(s) to grocery list.`; ui.showToast(toastMessage); document.getElementById('meal_modal').close(); },
    async handleMealPageFormSubmit(e) { e.preventDefault(); const form = document.getElementById('meal-page-form'); const date = form.querySelector('#meal-page-date').value; const mealType = form.querySelector('#meal-page-type').value; const existingMeal = (app.data.meals || []).find(m => m.date === date && m.mealType === mealType); if (existingMeal) { ui.showToast('A meal already exists for this date and time.', 'error'); return; } const meal = { date, mealType, recipeName: form.querySelector('#meal-page-recipeName').value, recipeURL: '', ingredients: [] }; const newDoc = await db.add('meals', meal); ui.showToast('Meal created! Now add ingredients.'); form.reset(); document.querySelector('#mealplanner-view details').open = false; ui.openMealModal(meal.date, meal.mealType, newDoc.id); },
    handleAddIngredient() { const input = document.getElementById('new-ingredient-name'); const name = input.value.trim(); if (name) { ui.renderIngredientListItem({ name, status: 'Need' }); input.value = ''; input.focus(); } },
    async addNeededIngredientsToGroceries(meal) { if (!this.activeStore) { ui.showToast("Cannot add ingredients without an active shopping list.", "error"); return 0; } let itemsAddedCount = 0; const neededIngredients = meal.ingredients.filter(ing => ing.status === 'Need'); const batch = writeBatch(fb_db); for (const ingredient of neededIngredients) { const exists = (app.data.groceries || []).some(g => g.itemName.toLowerCase() === ingredient.name.toLowerCase()); if (!exists) { const docRef = doc(collection(fb_db, db._getCollectionPath('groceries'))); batch.set(docRef, { storeId: this.activeStore.id, itemName: ingredient.name, isChecked: false, price: null, fromRecipe: meal.recipeName }); itemsAddedCount++; } } await batch.commit(); return itemsAddedCount; },
    async handleDeleteMeal() { const mealId = document.getElementById('mealId').value; if (mealId && confirm('Are you sure you want to delete this meal?')) { await db.delete('meals', mealId); document.getElementById('meal_modal').close(); ui.showToast('Meal deleted.'); } },
    async addFamilyMember(e) { e.preventDefault(); const nameInput = document.getElementById('new-member-name'); const name = nameInput.value.trim(); if (name) { await db.add('familyMembers', { name }); ui.showToast('Family member added.'); nameInput.value = ''; } },
    async deleteFamilyMember(id) { if(confirm('Are you sure?')){ await db.delete('familyMembers', id); ui.showToast('Family member removed.'); } },
    async clearAllData() { if (confirm("DANGER: This will permanently delete ALL data from the cloud for your user account. Are you sure?")) { for (const storeName of OBJECT_STORES) { await db.clear(storeName); } this.activeStore = null; ui.showToast('All cloud data has been cleared.'); document.getElementById('manage_modal').close(); } },
    exportData() { const dataToExport = { ...this.data }; const text = JSON.stringify(dataToExport, null, 2); const blob = new Blob([text], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `home-hub-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); ui.showToast('Local data exported.'); },
    async importData(event) { const file = event.target.files[0]; if (!file) return; if (!confirm('This will overwrite all current cloud data. Proceed?')) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = async (e) => { try { const importedData = JSON.parse(e.target.result); for (const storeName of OBJECT_STORES) { await db.clear(storeName); if (importedData[storeName]) { const batch = writeBatch(fb_db); importedData[storeName].forEach(item => { const docRef = doc(collection(fb_db, db._getCollectionPath(storeName))); const { id, ...data } = item; batch.set(docRef, data); }); await batch.commit(); } } ui.showToast('Data imported successfully!'); document.getElementById('manage_modal').close(); } catch (err) { console.error("Import error:", err); ui.showToast('Failed to import data.', 'error'); } }; reader.readAsText(file); event.target.value = ''; }
};

// --- INITIALIZATION ---
const initFirebase = async () => {
    // Use the dynamically provided config if available, otherwise use the hardcoded one.
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : providedFirebaseConfig;
    
    if (!firebaseConfig.apiKey) { 
        console.error("Firebase config is missing!"); 
        document.body.innerHTML = '<div class="alert alert-error m-4">Firebase configuration is missing. The app cannot start.</div>';
        return; 
    }
    const fb_app = initializeApp(firebaseConfig);
    fb_db = getFirestore(fb_app);
    fb_auth = getAuth(fb_app);

    onAuthStateChanged(fb_auth, async (user) => {
        if (user) {
            userId = user.uid;
            console.log("User signed in:", userId);
            app.init();
            setupRealtimeListeners();
            await seedInitialData();
        } else {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(fb_auth, __initial_auth_token);
                } else {
                    await signInAnonymously(fb_auth);
                }
            } catch (error) { console.error("Authentication error:", error); }
        }
    });
};

const setupRealtimeListeners = () => {
    unsubscribes.forEach(unsub => unsub());
    unsubscribes = [];
    OBJECT_STORES.forEach(storeName => {
        const q = query(collection(fb_db, db._getCollectionPath(storeName)));
        const unsub = onSnapshot(q, (snapshot) => {
            app.data[storeName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            ui.renderAll();
        }, (error) => {
             console.error(`Error listening to ${storeName}:`, error);
        });
        unsubscribes.push(unsub);
    });
};

const seedInitialData = async () => {
    const membersSnapshot = await getDocs(collection(fb_db, db._getCollectionPath('familyMembers')));
    if (!membersSnapshot.empty) return;
    
    console.log("Seeding initial data for new user...");
    const batch = writeBatch(fb_db);
    const today = new Date().toISOString().split('T')[0];

    const familyData = [{name: 'Mom'}, {name: 'Dad'}, {name: 'Kid'}];
    familyData.forEach(member => {
        const docRef = doc(collection(fb_db, db._getCollectionPath('familyMembers')));
        batch.set(docRef, member);
    });
    
    const taskData = { name: "Doctor's Appointment", type: 'Appointment', assignee: 'Mom', dueDate: today, dueTime: '10:00', isRecurring: false, recurringDays: [], status: 'To Do', notes: 'Annual check-up' };
    batch.set(doc(collection(fb_db, db._getCollectionPath('tasks'))), taskData);
    
    const storeData = { name: 'Local Grocer' };
    const storeRef = doc(collection(fb_db, db._getCollectionPath('stores')));
    batch.set(storeRef, storeData);
    
    await batch.commit();
    console.log("Initial data seeded.");
};

document.addEventListener('DOMContentLoaded', () => {
    themeManager.init();
    initFirebase();
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered.', reg))
            .catch(err => console.log('SW registration failed:', err));
        });
    }
});
// Make key functions globally available for inline handlers
window.ui = ui;
window.app = app;
</script>

</body>
</html>

